<!-- $.Param function checks first in the content frontmatter for the param, falling back
to Site config.   Info: https://gohugo.io/functions/param/ -->
{{ $bannerParameters := $.Param "announcement_banner" }}
{{ $customBannerBackgroundStyle := "" }}

{{ $isCustomBanner := false }}
{{ if .Params.announcement_banner }}
	{{ $isCustomBanner = true }}
{{ end }}

{{ if and ($bannerParameters.gradient_color_one) ($bannerParameters.gradient_color_two) }}
	{{ $customBannerBackgroundStyle = print "background: linear-gradient(45deg, " $bannerParameters.gradient_color_one " 0%, "  $bannerParameters.gradient_color_two " 100%);" }}
{{ else if $bannerParameters.background_color }}
	{{ $customBannerBackgroundStyle = print "background:" $bannerParameters.background_color ";" }}
{{ end }}

<div class="announcement-banner text-center {{ if $.Site.Params.announcement_banner.html }}announce-html{{ end }}" {{ if ne $customBannerBackgroundStyle "" }}style="{{ $customBannerBackgroundStyle | safeCSS }}"{{ end }}>
	<!-- Custom styled announcement banner with no link.   This is used on event templates. -->
	{{ if $bannerParameters.custom_event_banner }}
		<p class="text-white font-weight-semibold px-2 px-md-5 py-1 no-event">{{ $bannerParameters.desktop_message | safeHTML }}</p>
	{{ else }}

		<!-- Standard customizable or default announcement banner -->
		{{ if or ($bannerParameters.external_link) ($.Site.Params.announcement_banner.external_link) }}
			{{ $externalLink := $bannerParameters.external_link | default $.Site.Params.announcement_banner.external_link }}
			<a class="font-weight-semibold text-nowrap" href="{{ $externalLink }}">
		{{ else if or ($bannerParameters.link) ($.Site.Params.announcement_banner.link) }}
				{{ $link := $bannerParameters.link | default $.Site.Params.announcement_banner.link }}
			<a class="font-weight-semibold text-nowrap" href="{{ "" | absLangURL }}{{ $link }}?ref=announcement-banner">
		{{ end }}
				<span class="d-none d-md-block banner-title-desktop">
					{{ $bannerParameters.desktop_message | default $.Site.Params.announcement_banner.desktop_message | safeHTML }}
				</span>
				<span class="d-block d-md-none banner-title-mobile">
					{{ if or ($bannerParameters.mobile_message) ($.Site.Params.announcement_banner.mobile_message) }}
						{{ $bannerParameters.mobile_message | default $.Site.Params.announcement_banner.mobile_message | safeHTML }}
					{{ else }}
						{{ $bannerParameters.desktop_message | default $.Site.Params.announcement_banner.desktop_message | safeHTML }}
					{{ end }}
				</span>
			</a>
		{{ end }}

	<script>
		// JS code is inline in order to access the webinars.yaml hugo data file.  This allows DemandGen to continue easily making webinar banner updates.
		const isCustomBanner = {{ $isCustomBanner }}
		const webinarList = {{ $.Site.Data.en.webinars }}

		// Custom announcement banner params should override geotargeted webinar params.
		if (!isCustomBanner) {
			// AWS lambda endpoint to fetch user's geolocation
			const apiUrl = window.document.URL.match('(www|docs).datadoghq.com') ? 'https://t0wkqjqlwh.execute-api.us-east-1.amazonaws.com/prod/locate' : 'https://dfjcj4bhz0.execute-api.us-east-1.amazonaws.com/staging/locate';
			let countryCode = 'US';

			const locate = new Promise((resolve, reject) => {
				if (window.Storage) {
					if (localStorage.getItem('country') !== null) {
						return resolve(localStorage.getItem('country'));
					}
				}

				return fetch(apiUrl)
					.then(response => response.json())
					.then(data => {
						if (window.Storage) {
							localStorage.setItem('country', data.country);
						}

						return data.country;
					})
					.catch(err => {
						console.error(`Fetching geolocation data failed - ${err}`);
					})
			})

			countryCode = locate.then(code => {
				let webinarLinkExists = false;

				webinarList.webinars.forEach(webinar => {
					if (webinar.codes.includes(code)) {
						updateBanner(webinar);
						webinar.lp_link ? webinarLinkExists = true : webinarLinkExists = false;
					}
				})

				// Remove announcement banner on dg + landing-page LPs unless there is webinar specific geolocation data
				{{ if in (slice "dg" "landing-page") .Type }}
					if (!webinarLinkExists) {
						window.addEventListener('DOMContentLoaded', () => {
								document.getElementsByTagName("html")[0].classList.remove('open');
								// on page load banner existed so we applied margin
							// now delayed removing of banner leaves gap, this corrects it
								if(window.innerWidth <= 992) {
									document.querySelector('.navbar').style.marginTop = 0;
							}
						});
					}
				{{ end }}
			})
			.catch(err => {
				console.error(`Fetching geolocation data failed - ${err}`);
			})
		}
		
		/**
			* @param {Array} webinar - Data from site/data/en/webinars.yaml for the webinar matching user's country code.
		*/
		function updateBanner(webinar) {
			const today = new Date();
			const startDate = new Date(webinar.start_date);
			const endDate = new Date(webinar.end_date);

			if (today >= startDate && today <= endDate) {
				document.querySelector('.banner-title-desktop').innerHTML = webinar.desktop_title;
				document.querySelector('.banner-title-mobile').innerHTML = webinar.mobile_title;

				// Using different link for dg + landing-page LPs
				{{ if in (slice "dg" "landing-page") .Type }}
					document.querySelector(".announcement-banner > a").href = webinar.lp_link;
				{{ else }}
					document.querySelector(".announcement-banner > a").href = webinar.link;
				{{ end }}
			}
		}
	</script>
</div>